{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.2.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'accueil_utilisateur/css/tailwindcss-colors.css' %}">
    <link rel="stylesheet" href="{% static 'accueil_utilisateur/css/styles.css' %}">
    <link rel="stylesheet" href="{% static 'accueil_utilisateur/css/publier_video.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css"/>


    <title>Chat</title>
</head>
<body>
{% url 'Utilisateur:accueil_utilisateur' as accueil_utilisateur %}
{% url 'Utilisateur:acceuil' as Acceuil %}
{% url 'Utilisateur:detail_utilisateur' utilisateur_detail_id=utilisateur_detail.id as detail_url %}
<style>
    .conversation{
    {% if request.user.theme_sombre %}
        background-color: rgb(22 24 24);
    {% else %}
        background-color: rgb(255, 255, 255);
    {% endif %}
    }
    .blurred {
        backdrop-filter: blur(20px);
        pointer-events: none;
    }

    .video-container {
        width: 100%;
        padding-bottom: 56.25%;
        position: relative;
        margin-bottom: 20px;
    }

    .video {
        position: absolute;
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 10px;
    }

    .full-screen-video {
        width: 100%;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 100vh;
    }

    .full-screen-video video {
        max-width: 100%;
        max-height: 100%;
    }
    .preview-container {
        margin-top: auto;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        min-height: 200px;
        max-height: 500px;
        overflow-y: auto;
    }
    .preview-container .preview-item {
        position: relative;
    }
    .preview-container img.preview-image {
        min-width: 550px;
        max-width: 550px;
        height: auto;
        object-fit: cover;
        border-radius: 5px;
        border: 1px solid #ddd;
    }
    .preview-container .remove-btn {
        position: absolute;
        top: 5px;
        left: 5px;
        background: red;
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 12px;
    }
    #audioPreviewContainer {
        display: flex;
        align-items: center;
        padding: 8px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        background-color: #f0f0f0;
    }
    #audioControls {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-left: 10px;
    }

    button {
        background-color: #fff;
        border: none;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        color: #007bff;
    }
    #removeAudioButton {
        background-color: transparent;
        border: none;
        color: #ff5c5c;
        cursor: pointer;
        margin-left: auto;
    }

    /* Barre de progression */
    #progressBar {
        width: 150px;
        height: 4px;
        background-color: #e0e0e0;
        border-radius: 2px;
        appearance: none;
    }

    #progressBar::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 8px;
        height: 8px;
        background-color: #007bff;
        border-radius: 50%;
        cursor: pointer;
    }

    .message-image_afficher{
        max-width: 400px;
        min-width: 300px;
        height: auto;
    }
    #recordingDuration {
        font-size: 16px; /* Taille de police */
        color: #653737; /* Couleur du texte */
        text-align: center; /* Centrage du texte */
        margin-bottom: 10px; /* Marge inférieure */
    }
    #video-upload-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 10px;
        width: 100%; /* Utilise 100% de la largeur disponible */
    }

    /* Styles pour le bouton de téléchargement */
    #upload-button {
        background-color: #007BFF;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 10px;
        font-size: 1.5rem;
        cursor: pointer;
        margin-bottom: 10px;
        transition: background-color 0.3s;
    }

    #upload-button:hover {
        background-color: #0056b3;
    }

    /* Styles pour les boutons d'envoi et d'annulation */
    #form-controls {
        display: flex;
        justify-content: space-between; /* Place les boutons de manière égale */
        width: 100%; /* Prend toute la largeur disponible */
        margin-bottom: 10px; /* Ajoute de l'espace en bas */
    }

    #cancel-button, #send-button {
        background-color: #f44336; /* Rouge pour le bouton annuler */
        color: white;
        border: none;
        border-radius: 5px;
        padding: 10px;
        font-size: 1rem;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    #send-button {
        width: 100px;
        background-color: #28a745; /* Vert pour le bouton envoyer */
    }

    #cancel-button:hover {
        background-color: #d32f2f;
        width: 100px;
    }

    #send-button:hover {
        background-color: #218838;
    }

    #photo-icon {
        cursor: pointer;
        width: 40px;
        height: 40px;
        transition: opacity 0.3s ease;
        font-size: 35px;
    }
    #publication-action-icon {
        cursor: pointer;
        width: 40px;
        height: 40px;
        transition: opacity 0.3s ease;
        font-size: 40px;
    }
    #photo-icon:hover {
        opacity: 0.7;
    }

    #publish-form {
        position: fixed;
        width: 100%;
        background-color: #fff;
        border: 1px solid #dddfe2;
        border-radius: 8px;
        padding: 16px;
        margin-top: 16px;
        z-index: 100;
        overflow-y: auto;
        max-height: 500px;
    }

    #publish-form label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;

    }

    #publish-form input[type="text"],
    #publish-form input[type="file"] {
        width: calc(100% - 20px);
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    #publish-form button {
        width: 100%;
        padding: 10px;
        background-color: #28a745;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    #publish-form button:hover {
        background-color: #218838;
    }
    #image-editor {
        margin-bottom: 20px;
        border: 1px solid #ccc;
        border-radius: 5px;
        overflow: hidden;
        width: 100%;
        height: 200px;
    }

    #image-editor img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .content-messages {
        margin: 20px auto;
        width: 100%;
        overflow-y: auto;
        height: 100%;
        margin-top: 16px;
    }
    .publication-container {
        margin: auto;
    }

    .publication {
        background-color: #fff;
        border-radius: 5px;
        margin-bottom: 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
    {% if request.user.theme_sombre %}
        background-color:#020101;
        color: white;
    {% else %}
        background-color: rgb(255, 255, 255);
    {% endif %}

    }
    .navbar{
    {% if request.user.theme_sombre %}
        background-color:#020101;
        color: white;
    {% else %}
        background-color: rgb(255, 255, 255);
    {% endif %}
    }

    .publication-header {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }

    .user-profile {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 10px;
    }

    .user-info {
        display: flex;
        flex-direction: column;
    }
    .user-name {
        margin: 0;
        font-weight: bold;
    }

    .publication-time {
        margin: 0;
        font-size: 0.9rem;
        color: gray;
    }

    /* Contenu de la publication */
    .publication-content {
        margin-bottom: 10px;
    }

    .publication-image {
        width: 100%;
        border-radius: 5px;
        margin-top: 10px;
    }

    .publication-actions {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
    }

    .action-button {
        border: none;
        background-color: #f0f2f5;
        padding: 10px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1.5rem;
    }

    .action-button:hover {
        background-color: #e9ebee;
    }

    /* Section des commentaires */
    .comments-section {
        align-items: center;
        display: none;
        border-top: 1px solid #ccc;
        padding-top: 10px;
        position: relative;
    }

    .commentaire-form {
        display: flex;
        justify-content: space-between;
        position: sticky;
        bottom: 0;
        padding: 10px;
        background-color: #f9f9f9;
        border-top: 1px solid #cccccc;
        z-index: 1;
        box-sizing: border-box;

    }
    .comment {
        box-sizing: border-box;
        padding: 10px;
        border-bottom: 1px solid #e0e0e0;
        margin-bottom: 10px;
    }

    .commentaire-input {
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 5px;
        width: 100%;
    }

    .commentaire-form button {
        border: none;
        background-color: #007bff;
        color: #fff;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
    }

    .liked {
        color: red;
    }
    .action-button.liked i {
        color: #ff4d4d;
    }
    .comment-count {
        font-size: 1rem;
        color: #888;
        margin-left: 5px;
    }
    .likes-container {
        display: flex;
        align-items: center;
    }
    .comment-count-container {
        display: flex;
        align-items: center;
        justify-content: space-between; /
    }

    .likes-container button,
    .likes-container span {
        margin-right: 5px;
    }
    .comment-count-container button,
    .comment-count-container span {
        margin-right: 5px;
    }
    .comment-actions {
        display: flex;
        gap: 10px;
    }
    .comments-container {
        width: 100%;
        border: 1px solid #cccccc;
        padding: 10px;
        margin-top: 10px;
        background-color: #dcd9d9;
        border-radius: 5px;
    }



    .comment-user {
        font-weight: bold;
        color: #333333;
    }

    .comment-text {
        margin: 5px 0;
        color: #666666;
    }


    .comment-time {
        font-size: 12px; /
    color: #999999;
    }
    @media (max-width: 480px) {
        .commentaire-form {
            width: 100%;
        }
        .comments-container {
            width: 100%;
        }
    }




    .content-message-unread i {
        color: #007bff;
        font-size: 20px;
    }
    .lien-utilisateur {
        display: flex;
        align-items: center;
        text-decoration: none;
        color: #333;
    }
    #publicationSection {
        position: fixed;
        width: 100%;
        background-color: #fff;
        border: 1px solid #dddfe2;
        border-radius: 8px;
        padding: 16px;
        margin-top: 16px;
        z-index: 100;
        overflow-x: auto;

    }

    #publicationForm {
        margin-bottom: 16px;
        overflow-y: auto;
        max-height: 400px;
    }

    #texteInput {
        width: 100%;
        padding: 12px;
        border: 1px solid #dddfe2;
        border-radius: 8px;
        margin-bottom: 12px;
        resize: none;
    }

    #couleurFond {
        margin-right: 8px;
    }

    #preview {
        border-top: 1px solid #dddfe2;
        padding-top: 16px;
    }

    #textePreview {
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 12px;
        min-height: 200px;
        max-height: 200px;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow-x: hidden;
    }

    #publicationButton {
        background-color: #1877f2;
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 12px 24px;
        cursor: pointer;
        width: 100%;
        transition: background-color 0.3s ease;
    }

    #publicationButton:hover {
        background-color: #166fe5;
    }

</style>
<div id="publicationSection" style="display: none;">
    <i onclick="" style="font-size: 30px" class="bi bi-x-circle-fill"></i>
    <form id="publicationForm" action="{% url 'Utilisateur:creer_publication' %}" method="post">
        {% csrf_token %}
        <div id="emojiSection" style="position: absolute; right: 0; margin-right: 20px">
            <button id="emojiButton" type="button" style="font-size: 40px; margin-top: 20px">😊</button>
            <div id="emojiPanel" style="display: none;">
                <span onclick="insertEmoji('😊')">😊</span>
                <span onclick="insertEmoji('❤️')">❤️</span>
                <span onclick="insertEmoji('👍')">👍</span>
                <span onclick="insertEmoji('😟')">😟</span>
                <span onclick="insertEmoji('😅')">😅</span>
                <span onclick="insertEmoji('😰')">😰</span>
            </div>
        </div>
        <textarea id="texteInput" name="texte" placeholder="Écrivez votre publication ici"></textarea>
        <input type="hidden" id="couleurFondHidden" name="couleur_fond" value="">
        <div id="backgroundOptions" style="overflow-x: auto; white-space: nowrap;">
            <div class="backgroundOption" data-value="linear-gradient(to bottom, rgba(255,128,255,0.5), rgba(0,0,128,0.5))" style="background-image: linear-gradient(to bottom, rgba(255,128,255,0.5), rgba(0,0,128,0.5)); border-radius: 50%; width: 50px; height:  50px; display: inline-block; margin-right: 10px;"></div>
            <div class="backgroundOption" data-value="linear-gradient(to bottom, rgba(128,0,128,0.5), rgba(0,0,128,0.5))" style="background-image: linear-gradient(to bottom, rgba(128,0,128,0.5), rgba(0,0,128,0.5)); border-radius: 50%; width: 50px; height:  50px; display: inline-block; margin-right: 10px;"></div>
            <div class="backgroundOption" data-value="linear-gradient(to bottom, rgba(0,128,0,0.5), rgba(0,0,128,0.5))" style="background-image: linear-gradient(to bottom, rgba(0,128,0,0.5), rgba(0,0,128,0.5)); border-radius: 50%; width: 50px; height:  50px; display: inline-block; margin-right: 10px;"></div>
            <div class="backgroundOption" data-value="linear-gradient(to bottom, rgba(255,105,180,0.5), rgba(255,165,0,0.5))" style="background-image: linear-gradient(to bottom, rgba(255,105,180,0.5), rgba(255,165,0,0.5)); border-radius: 50%; width: 50px; height:  50px; display: inline-block; margin-right: 10px;"> </div>
            <div class="backgroundOption" data-value="linear-gradient(90deg, #020024 0%, #090979 35%, #00d4ff 100%)" style="background-image: linear-gradient(90deg, #020024 0%, #090979 35%, #00d4ff 100%);; border-radius: 50%; width: 50px; height:  50px; display: inline-block; margin-right: 10px;"> </div>
            <div class="backgroundOption" data-value="url('{% static 'bacground image/smile.png' %}')" style="background-image: url('{% static 'bacground image/smile.png' %}'); border-radius: 50%; width: 50px; height:  50px; display: inline-block; margin-right: 10px;'"> </div>
        </div>
        <h3>Aperçu</h3>
        <div id="preview">
            <div id="textePreview"></div>
        </div>
        <button id="publicationButton" type="submit">Publier</button>
    </form>
</div>
<form id="publish-form" style="display: none;">
    <i onclick="" style="font-size: 30px" class="bi bi-x-circle-fill"></i>
    <label for="titre">Titre de l'image:</label>
    <input type="text" id="titre_photo" name="titre" required>

    <label for="photo_file">Sélectionner une image:</label>
    <input hidden="hidden" type="file" id="photo_file" name="photo_file" accept="image/*" required>

    <div id="image-editor">
        <img id="image-to-edit" alt="Prévisualisation">
    </div>
    <button type="submit">Publier</button>
</form>
<div class="conversation {% if request.path == Acceuil %}active{% else %} {% endif %}" id="Acceuil" style="margin-top: 60px; min-width: 100%">
    <div class="conversation-main">
        <nav class="navbar">
            <i style="color: #7906a5;" id="publication-action-icon" class="bi bi-fonts"></i>
            <i style="color: #7906a5; margin-left: 10px" id="photo-icon" class="bi bi-patch-plus"></i>
            <div class="profile-dropdown" style="margin-left: auto;">
                <div onclick="toggle()" class="profile-dropdown-btn">
                    <div class="profile-img">
                        <img class="profile-img" style="" src="{{ request.user.image.url }}">
                    </div>
                </div>

                <ul class="profile-dropdown-list">
                    <li class="profile-dropdown-list-item">
                        <a href="#">
                            <i class="fa-regular fa-user"></i>
                            Modifier le profile
                        </a>
                    </li>
                    <li class="profile-dropdown-list-item">
                        <a href="{% url 'Utilisateur:parametre' %}">
                            <i class="fa-solid fa-sliders"></i>
                            Parametre
                        </a>
                    </li>
                    <li class="profile-dropdown-list-item">
                        <a href="#">
                            <i class="fa-regular fa-circle-question"></i>
                            Aide et support
                        </a>
                    </li>
                    <hr />
                    <li class="profile-dropdown-list-item">
                        <a href="#" onclick="deconnexion();">
                            <i class="fa-solid fa-arrow-right-from-bracket"></i>
                            Déconnexion
                        </a>
                    </li>
                </ul>
            </div>
        </nav>
        {% if Publication_alls  %}
            {% for photo in Publication_alls %}
                <div class="publication-container">
                    <div class="publication">
                        <div class="publication-header">
                            <img src="{{ photo.utilisateur.image.url }}" alt="Profil de l'utilisateur" class="user-profile">
                            <div class="user-info">
                                <p class="user-name">{{ photo.utilisateur.nom }} {{ photo.utilisateur.prenom }}  <img style="width: 20px; margin-top: 10px" src="{% static 'badge.png' %}" alt="Badge certifié"></p>
                                <p class="publication-time"><i class="bi bi-globe-americas"></i> Il y a {{ photo.date_pub }}</p>
                            </div>

                        </div>
                        {% if photo.photo_file  %}
                            <div class="publication-content">
                                <p>{{ photo.titre }}</p>
                                <img src="{{ photo.photo_file.url }}" alt="Image de la publication" class="publication-image">
                            </div>
                        {% else  %}
                            <div class="publication-content" style=" min-height: 400px; display: flex; justify-content: center; align-items: center; background-image:{{ photo.couleur_fond }} ">
                                <div class="publication-content" style="color: white">
                                    {{ photo.contenu }}
                                </div>
                            </div>
                        {% endif  %}
                        <div class="row publication-actions">
                            <div class="col-4 likes-container" style="font-size: 11px; padding-left: 20px;">
                                <button class="action-button" id="like-button" data-publication-id="{{ photo.id }}">
                                    <i class="bi bi-heart-fill"></i>
                                </button>
                                <span class="likes-count">
                                    {% for key, value in publication_likes.items %}
                                        {% if key == photo.id %}
                                            {{ value }}
                                        {% endif %}
                                    {% endfor %}
                                </span> likes
                            </div>
                            <div class="col-4 comment-count-container" style="font-size: 11px; padding-right: 20px;">
                                <button class="action-button" id="comment-button" data-publicationafficher-id="{{ photo.id }}"><i class="bi bi-chat"></i></button>
                                <span class="comment-count" id="comment-count-{{ photo.id }}"></span> commentaires
                            </div>
                            <div class="col-4 comment-count-container" style="font-size: 10px; padding-right: 30px; margin-right: 10px;">
                                <span class="comment-count">15,42k</span> Vues
                            </div>
                        </div>
                        <div class="comments-section" id="comments-section-{{ photo.id }}" style="overflow-y: auto; overflow-x: none; max-height: 300px">
                            <div class="comments-container" id="comments-container-{{ photo.id }}">
                                <!-- Les commentaires seront ajoutés ici -->
                            </div>
                            <form class="commentaire-form" id="commentaire-form-{{ photo.id }}">
                                {% csrf_token %}
                                <input type="text" class="commentaire-input" id="commentaire-input-{{ photo.id }}" placeholder="Écrivez un commentaire...">
                                <button type="submit" data-publications-id="{{ photo.id }}">▶️</button>
                            </form>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% endif %}
    </div>
</div>

<div class="conversation {% if request.path == accueil_utilisateur %}active{% else %} {% endif %}"  id="Chats" style="margin-top: 60px">
    <div class="conversation-main">
        <div class="content-messages">
            <ul class="content-messages-list">
                <li class="content-message-title"><span>Utilisateur</span>
                    {% if utilisateurs %}
                        {% for utilisateur in utilisateurs %}
                            <li >
                                <a href="{% url 'Utilisateur:detail_utilisateur' utilisateur_detail_id=utilisateur.id %}" class="lien-utilisateur" data-utilisateur-id="{{ utilisateur.id }}">
                                    {% if utilisateur.image %}
                                        <img class="content-message-image" src="{{ utilisateur.image.url }}" alt="Image de {{ utilisateur.nom }}">
                                    {% else %}
                                    {% endif %}
                                    <span class="content-message-info">
                                        <span class="content-message-name">{{ utilisateur.nom }} {{ utilisateur.prenom }}</span>
                                        <span class="content-message-text">Ecrire a cet utilisateur</span>
                                    </span>
                                    <span class="content-message-more">
                                        <span class="content-message-unread"><i class="bi bi-chat"></i></span>
                                    </span>
                                </a>
                            </li>
                        {% endfor %}
                    {% endif %}
            </ul>
        </div>
    </div>
</div >

{% if utilisateur_detail %}
    <div class="conversation conversation_message {% if request.path == detail_url %}active{% else %} {% endif %}" id="conversation-1" data-utilisateur-id="{{ utilisateur_detail.id }}" >
        <div class="conversation-top">
            <a class="conversation-back" href="{% url 'Utilisateur:accueil_utilisateur' %}"><i class="ri-arrow-left-line"></i></a>
            <div class="conversation-user">
                <img class="content-message-image" src="{{ utilisateur_detail.image.url }}" alt="Image de {{ utilisateur.nom }}">
                <div>
                    <div class="conversation-user-name">{{ utilisateur_detail.nom }} {{ utilisateur_detail.prenom }}</div>

                    <div class="conversation-user-status"><span class="conversation-user-statu-point"></span> En ligne</div>
                </div>
            </div>
            <div class="conversation-buttons">
                <button type="button"><i class="ri-phone-fill"></i></button>
                <button type="button"><i class="ri-vidicon-line"></i></button>
                <button type="button"><i class="ri-information-line"></i></button>
            </div>
        </div>
        <div class="conversation-main" style="background-image: url('{% static 'font_decran.png' %}')" id="conversation-main">
            <ul class="conversation-wrapper" id="conversation-wrappers">
            </ul>
        </div>
        <div id="audioPreviewContainer" style="display: none;">
            <audio id="audioPreview"></audio>
            <div id="audioControls">
                <button id="playButton"><i class="bi bi-play-circle-fill"></i></button>
                <button id="pauseButton"><i class="bi bi-stop-circle"></i></button>
                <input type="range" id="progressBar" min="0" max="100" value="0" step="0.1">
            </div>
            <button id="removeAudioButton"><i class="bi bi-trash"></i></button>

        </div>
        <form class="conversation-form message_image" id="message-form">
            {% csrf_token %}
            <input type="hidden" name="utilisateur_id" value="{{ utilisateur_detail.id }}">
            <button class="recordButton" id="recordButton"><i style="font-size: 25px;" class="bi bi-mic"></i>

            </button>
            <div id="recordingDuration">00:00</div>
            <input type="file" id="audioInput" name="audio" style="display: none;">
            <div class="conversation-form-group">
                <textarea id="message-input" name="contenu_message" class="conversation-form-input" rows="1" placeholder="Écrivez..."></textarea>
                <input class="image_input" id="image_input" type="file" name="images" multiple accept="image/*">
                <button type="button" class="conversation-form-record"><i style="font-size: 25px;" class="bi bi-image"></i></button>
            </div>
            <button type="submit" class="conversation-form-button conversation-form-submit"><i class="ri-send-plane-2-line"></i></button>
            <audio id="submitSound" src="{% static 'SonEnvoi/envoiSon.mp3' %}"></audio>

        </form>
    </div>
{% endif %}


<script>
    setInterval(reeceptionMesaage, 500)
    let cunter = 0
    let displayedMessageIds = new Set();

    function afficherMessages(data) {
        let utilisateur_detail_id = document.querySelector('.conversation_message').dataset.utilisateurId;
        let conversationWrappers = document.getElementById('conversation-wrappers');

        data.forEach((message) => {
            if (displayedMessageIds.has(message.id)) {
                return;
            }
            let chatMessageBox = document.createElement("li");
            if (message.recoi_id != utilisateur_detail_id) {
                chatMessageBox.classList.add("conversation-item", "me");
            } else {
                chatMessageBox.classList.add("conversation-item");
            }

            let contenuHTML = '';
            if (message.images) {
                contenuHTML += `<p class="message-image"><img class="message-image_afficher img-fluid" src="${message.images}" alt="Image"></p>`;
            } else if (message.audio) {
                contenuHTML += `
        <div class="message-audio">
            <audio controls>
                <source src="${message.audio}" type="audio/webm">
            </audio>
        </div>
    `;
            } else if (message.contenu_message) {
                contenuHTML += `<p class="message-text">${message.contenu_message}</p>`;
            }

            chatMessageBox.innerHTML = `
    <div class="conversation-item-side">
        <img class="conversation-item-image" src="https://images.unsplash.com/photo-1534528741775-53994a69daeb?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8OXx8cGVvcGxlfGVufDB8fDB8fHww&auto=format&fit=crop&w=500&q=60" alt="">
    </div>
    <div class="conversation-item-content">
        <div class="conversation-item-wrapper">
            <div class="conversation-item-box">
                <div class="conversation-item-text">
                    ${contenuHTML}
                    <div class="conversation-item-time">${message.timestamp}</div>
                </div>
            </div>
        </div>
    </div>
`;

            conversationWrappers.appendChild(chatMessageBox);

            displayedMessageIds.add(message.id);
        });
    }



    let lastMessageId = null;

    function reeceptionMesaage() {
        let utilisateur_detail_id = document.querySelector('.conversation_message').dataset.utilisateurId;
        if (utilisateur_detail_id) {
            let url = `{% url "Utilisateur:reception_message" %}?utilisateur_detail_id=${utilisateur_detail_id}`;
            if (lastMessageId) {
                url += `&since_id=${lastMessageId}`;
            }

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    console.log('Données reçues:', data);
                    if (data.length > 0) {
                        afficherMessages(data);
                        lastMessageId = data[data.length - 1].id;
                        console.log('Nouveau lastMessageId:', lastMessageId);
                    }
                })
                .catch(error => {
                    console.log("Erreur lors de la récupération des messages:", error);
                });
        }
    }
    setInterval(reeceptionMesaage, 300);
</script>

{#Envoi message#}
<script>
    let audioChunks = [];
    let audioRecorder;
    let isRecording = false;
    let intervalId;
    let startTime;


    navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
            audioRecorder = new MediaRecorder(stream);
            audioRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };
            audioRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const audioFile = new File([audioBlob], 'audio.webm', { type: 'audio/webm' });
                document.getElementById('audioInput').files = FileListItems([audioFile]);
                const audioPreviewContainer = document.getElementById('audioPreviewContainer');
                const audioPreview = document.getElementById('audioPreview');
                const audioURL = URL.createObjectURL(audioBlob);
                audioPreview.src = audioURL;
                audioPreviewContainer.style.display = 'block';

                audioChunks = [];
            };
        })
        .catch(error => {
            console.error("Erreur lors de l'accès au microphone : ", error);
        });

    const recordButton = document.getElementById('recordButton');
    recordButton.addEventListener('click', () => {
        if (isRecording) {
            audioRecorder.stop();
            document.getElementById('recordingDuration').innerText = '';
            stopRecordingDuration();

            isRecording = false;
            recordButton.innerHTML = '<i style="font-size: 25px;" class="bi bi-mic"></i>';
        } else {
            audioRecorder.start();
            startRecordingDuration();
            isRecording = true;
            recordButton.innerHTML = '<i style="font-size: 25px;" class="bi bi-stop"></i>';

        }
    });


    function startRecordingDuration() {
        startTime = Date.now();
        intervalId = setInterval(() => {
            const currentTime = Date.now();
            const elapsedTime = Math.floor((currentTime - startTime) / 1000);
            const minutes = Math.floor(elapsedTime / 60);
            const seconds = elapsedTime % 60;
            const formattedTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('recordingDuration').innerText = formattedTime;
        }, 1000);
    }
    function stopRecordingDuration() {
        clearInterval(intervalId);
    }

    $(document).ready(function() {
        $('#message-form').on('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(this);

            const textContent = $('#message-input').val().trim();
            const files = document.querySelector('input[name="images"]').files;
            const audioFile = document.querySelector('input[name="audio"]').files[0];
            let url;
            if (textContent && files.length > 0) {
                console.error("Les deux texte et images sont sélectionnés, veuillez n'en choisir qu'un seul.");
                return;
            } else if (textContent) {
                url = '{% url "Utilisateur:envoyer_message_text" %}';
            } else if (files.length > 0) {
                url = '{% url "Utilisateur:envoyer_message_images" %}';
            } else if (audioFile) {
                url = '{% url "Utilisateur:envoyer_message_audio" %}';
            } else {
                console.error("Aucune entrée valide (texte, image ou audio) détectée.");
                return;
            }

            $.ajax({
                type: 'POST',
                url: url,
                data: formData,
                contentType: false,
                processData: false,
                success: function(response) {
                    const audioElement = document.getElementById('submitSound');
                    audioElement.play();
                    $('#conversation-main').scrollTop($('#conversation-main')[0].scrollHeight);
                    $('#preview-container').empty();
                    $('#message-input').val('');
                    $('#image_input').val('');
                    $('#audioInput').val('');
                    $('#audioPreviewContainer').hide();
                },
                error: function(xhr, status, error) {
                    console.error(error);
                }
            });
        });
    });

    // Gestion de la prévisualisation audio
    const audioElement = document.getElementById('audioPreview');
    audioElement.controls = false;

    const playButton = document.getElementById('playButton');
    const pauseButton = document.getElementById('pauseButton');
    const progressBar = document.getElementById('progressBar');
    const removeAudioButton = document.getElementById('removeAudioButton');

    removeAudioButton.addEventListener('click', () => {
        audioPreviewContainer.style.display = 'none';
        document.getElementById('audioInput').value = '';
    });

    playButton.addEventListener('click', () => {
        audioElement.play();
    });

    pauseButton.addEventListener('click', () => {
        audioElement.pause();
    });

    audioElement.addEventListener('timeupdate', () => {
        const progressValue = (audioElement.currentTime / audioElement.duration) * 100;
        progressBar.value = progressValue;
    });

    progressBar.addEventListener('input', () => {
        const newTime = (progressBar.value / 100) * audioElement.duration;
        audioElement.currentTime = newTime;
    });
    function FileListItems(files) {
        const dataTransfer = new DataTransfer();
        files.forEach(file => dataTransfer.items.add(file));
        return dataTransfer.files;
    }
    function updateFileInput() {
        const previewContainer = document.getElementById('preview-container');
        const imageInput = document.getElementById('image_input');
        const files = [];
        previewContainer.querySelectorAll('.preview-item').forEach(previewItem => {
            const img = previewItem.querySelector('.preview-image');
            if (img && img.dataset.file) {
                const file = new File([img.dataset.file], img.alt, { type: 'image/*' });
                files.push(file);
            }
        });
    }

    function addPreviewImage(imageFile) {
        const previewContainer = document.createElement('div');
        previewContainer.id = 'preview-container';
        previewContainer.classList.add('preview-container');
        const previewItem = document.createElement('div');
        previewItem.classList.add('preview-item');

        const imgElement = document.createElement('img');
        imgElement.src = URL.createObjectURL(imageFile);
        imgElement.classList.add('preview-image');
        imgElement.dataset.file = imageFile;
        imgElement.alt = imageFile.name;

        const removeBtn = document.createElement('button');
        removeBtn.classList.add('remove-btn');
        removeBtn.innerHTML = '<i class="bi bi-archive-fill"></i>';
        removeBtn.addEventListener('click', function() {
            previewItem.remove();
            updateFileInput();
        });

        previewItem.appendChild(imgElement);
        previewItem.appendChild(removeBtn);
        previewContainer.appendChild(previewItem);

        updateFileInput();
    }

    document.querySelector('input[name="images"]').addEventListener('change', function(event) {
        const files = event.target.files;
        for (const file of files) {
            addPreviewImage(file);
        }
    });

</script>
{#Publication#}
<script>
    // Sélectionner les éléments HTML
    var photoIcon = document.getElementById('photo-icon');
    var publishForm = document.getElementById('publish-form');
    var imageElement = document.getElementById('image-to-edit');
    const blurContainer = document.getElementById('Acceuil');
    var cropper = null;

    photoIcon.addEventListener('click', function() {
        publishForm.style.display = 'block';
        blurContainer.classList.add('blurred');

    });

    document.querySelector('#photo_file').addEventListener('change', function(event) {
        var reader = new FileReader();
        reader.onload = function() {
            imageElement.src = reader.result;
            if (cropper) {
                cropper.destroy();
            }

            cropper = new Cropper(imageElement, {
                aspectRatio: NaN, // Permet un recadrage libre
                viewMode: 2, // Mode d'affichage souhaité
                movable: true, // Permet de déplacer l'image
                zoomable: true, // Permet de zoomer sur l'image
                rotatable: true, // Permet de faire pivoter l'image
                scalable: true, // Permet d'agrandir ou de réduire l'image
                ready: function() {
                }
            });
        };
        reader.readAsDataURL(event.target.files[0]);
    });

    // Ajouter des contrôles pour les fonctionnalités d'édition d'image
    function addImageEditingControls() {
        // Exemples de contrôles pour la rotation, le zoom, et d'autres modifications
        var rotateLeftButton = document.createElement('button');
        rotateLeftButton.innerText = 'Pivoter à gauche';
        rotateLeftButton.addEventListener('click', function() {
            cropper.rotate(-45);
        });

        var rotateRightButton = document.createElement('button');
        rotateRightButton.innerText = 'Pivoter à droite';
        rotateRightButton.addEventListener('click', function() {
            cropper.rotate(45);
        });

        var zoomInButton = document.createElement('button');
        zoomInButton.innerText = 'Zoom avant';
        zoomInButton.addEventListener('click', function() {
            cropper.zoom(0.1);
        });

        var zoomOutButton = document.createElement('button');
        zoomOutButton.innerText = 'Zoom arrière';
        zoomOutButton.addEventListener('click', function() {
            cropper.zoom(-0.1);
        });

        // Ajouter les boutons au DOM
        publishForm.appendChild(rotateLeftButton);
        publishForm.appendChild(rotateRightButton);
        publishForm.appendChild(zoomInButton);
        publishForm.appendChild(zoomOutButton);
    }

    // Appeler la fonction pour ajouter les contrôles après avoir initialisé Cropper.js
    function onCropperReady() {
        addImageEditingControls();
    }

    // Soumettre l'image modifiée
    publishForm.addEventListener('submit', function(event) {
        event.preventDefault();

        if (cropper) {
            cropper.getCroppedCanvas().toBlob(function(blob) {
                var formData = new FormData();
                formData.append('photo_file', blob, 'image.jpg');
                formData.append('titre', document.querySelector('#titre_photo').value);

                fetch("{% url 'Utilisateur:publier_photo' %}", {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            publishForm.style.display = 'none';
                            blurContainer.classList.add('blurred');
                        } else {
                            console.log('Erreur lors de la publication de l\'image : ' + data.errors);
                        }
                    })
                    .catch(error => {
                        console.error('Erreur lors de la requête AJAX :', error);
                        console.log('Une erreur s\'est produite lors de la soumission du formulaire.');
                    });
            });
        } else {
            alert('Veuillez sélectionner une image.');
        }
    });

</script>
<script>
    var photoIcon = document.getElementById('photo-icon');
    var photoInput = document.getElementById('photo_file');
    var publishForm = document.getElementById('publish-form');
    photoIcon.addEventListener('click', function() {
        photoInput.click();
        publishForm.style.display = 'block';
    });
</script>
{#Liker & commenter &afficher_commentaire#}
<script>
    document.querySelectorAll('#like-button').forEach(button => {
        button.addEventListener('click', function() {
            const publicationId = this.getAttribute('data-publication-id');
            fetch("{% url 'Utilisateur:liker_publication' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({ publication_id: publicationId }),
            })
                .then(response => response.json())
                .then(data => {
                    const likesCountElement = this.closest('.publication').querySelector('.likes-count');

                    if (data.liked) {
                        this.classList.add('liked');
                        likesCountElement.textContent = parseInt(likesCountElement.textContent) + 1;
                    } else {
                        this.classList.remove('liked');
                        likesCountElement.textContent = parseInt(likesCountElement.textContent) - 1;
                    }
                });
        });
    });
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.publication').forEach(publication => {
            // Définir publicationId avant de l'utiliser
            const commentButton = publication.querySelector(`[id^="comment-button"]`);
            const publicationId = commentButton.getAttribute('data-publicationafficher-id');

            const commentsSection = publication.querySelector(`#comments-section-${publicationId}`);
            const commentForm = publication.querySelector(`#commentaire-form-${publicationId}`);

            commentsSection.setAttribute('data-visible', 'false');

            commentButton.addEventListener('click', function() {
                const isVisible = commentsSection.getAttribute('data-visible') === 'true';

                if (isVisible) {
                    commentsSection.style.display = 'none';
                    commentsSection.setAttribute('data-visible', 'false');
                    clearInterval(intervalId);
                } else {
                    commentsSection.style.display = 'block';
                    commentsSection.setAttribute('data-visible', 'true');
                    afficherCommentaires(publicationId);
                }
            });

            commentForm.addEventListener('submit', function(event) {
                event.preventDefault();
                const texte = commentForm.querySelector(`#commentaire-input-${publicationId}`).value;

                if (texte.trim() === '') {
                    console.log('Le commentaire ne peut pas être vide');
                    return;
                }
                fetch("{% url 'Utilisateur:commenter_publication' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify({
                        publication_id: publicationId,
                        texte: texte
                    }),
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.utilisateur_nom && data.utilisateur_prenom && data.texte) {
                            commentForm.querySelector(`#commentaire-input-${publicationId}`).value = '';
                        } else {
                            console.error('Erreur lors de l\'ajout du commentaire :', data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Erreur :', error);
                    });
            });
        });
        let intervalId;
        function afficherCommentaires(publicationId) {
            const commentsContainer = document.querySelector(`#comments-container-${publicationId}`);
            function actualiserCommentaires() {
                fetch("{% url 'Utilisateur:afficher_commentaire' %}?publication_id=" + publicationId)
                    .then(response => response.json())
                    .then(data => {
                        commentsContainer.innerHTML = '';
                        data.forEach(commentaire => {
                            const commentaireElement = document.createElement('div');
                            commentaireElement.classList.add('comment');
                            var utilisateurConnecteId = {{ utilisateur_connecte.id|default:"null" }};
                            let nomUtilisateur = commentaire.utilisateur_id;
                            if (commentaire.utilisateur_id === utilisateurConnecteId) {
                                nomUtilisateur = 'vous';
                            } else {
                                nomUtilisateur = commentaire.utilisateur;
                                console.log(commentaire.utilisateur)
                            }
                            commentaireElement.innerHTML = `
                    <p class="comment-user">${nomUtilisateur}</p>
                    <p class="comment-text">${commentaire.texte}</p>
                    <p class="comment-time">${commentaire.date_comment}</p>
                `;
                            commentsContainer.appendChild(commentaireElement);
                        });
                    })
                    .catch(error => {
                        console.error('Erreur lors de la récupération des commentaires :', error);
                    });
            }
            intervalId = setInterval(actualiserCommentaires, 500);

            actualiserCommentaires();
        }
    });
    function getCookie(name) {
        const cookieValue = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');
        return cookieValue ? decodeURIComponent(cookieValue[2]) : null;
    }
</script>
<script>
    function nombreCommentaire() {
        $('.publication').each(function() {
            console.log('Publication element:', this);
            var actionsSection = $(this).find('.publication-actions');
            console.log('Actions section:', actionsSection);
            var commentButton = actionsSection.find('.action-button#comment-button');
            if (commentButton.length > 0) {
                var publicationId = commentButton.data('publicationafficher-id');
                console.log('Publication ID:', publicationId);
                var commentCountSpan = actionsSection.find('#comment-count-' + publicationId);
                if (commentCountSpan.length > 0) {
                    $.ajax({
                        url: "{% url 'Utilisateur:get_comment_count' %}",
                        type: 'GET',
                        data: {
                            publication_id: publicationId
                        },
                        success: function(data) {
                            commentCountSpan.text(data.comment_count);
                        },
                        error: function(xhr, status, error) {
                            console.error("Erreur lors de la récupération du nombre de commentaires : " + error);
                        }
                    });
                } else {
                    console.error('Aucun élément `comment-count-' + publicationId + '` trouvé');
                }
            } else {
                console.error('Aucun bouton de commentaire trouvé');
            }
        });
    }
    setInterval(nombreCommentaire, 2000);
</script>
<script>

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register("{% static 'accueil_utilisateur/js/service-worker.js' %}")
                .then((registration) => {
                    console.log('Service worker registered with scope:', registration.scope);
                })
                .catch((error) => {
                    console.error('Service worker registration failed:', error);
                });
        });
    }
</script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const publicationActionIcon = document.getElementById('publication-action-icon');
        const publicationSection = document.getElementById('publicationSection');
        const backgroundOptions = document.querySelectorAll('.backgroundOption');
        const couleurPreview = document.getElementById('couleurPreview');
        const texteInput = document.getElementById('texteInput');
        const textePreview = document.getElementById('textePreview');
        const couleurFondHidden = document.getElementById('couleurFondHidden');
        const blurContainer = document.getElementById('Acceuil');
        const closeIcon = document.querySelector('#publicationSection i.bi-x-circle-fill');

        publicationActionIcon.addEventListener('click', () => {
            if (publicationSection.style.display === 'none') {
                publicationSection.style.display = 'block';
                blurContainer.classList.add('blurred');
            } else {
                publicationSection.style.display = 'none';
            }
        });

        backgroundOptions.forEach(option => {
            option.addEventListener('click', () => {
                const backgroundImage = option.dataset.value;
                document.getElementById('preview').style.backgroundImage = backgroundImage;
                couleurFondHidden.value = backgroundImage;
            });
        });
        closeIcon.addEventListener('click', () => {
            publicationSection.style.display = 'none';
            blurContainer.classList.remove('blurred');
        });
        texteInput.addEventListener('input', updatePreview);
        function updatePreview() {
            const enteredText = texteInput.value;
            textePreview.textContent = enteredText;
        }
    });
</script>

<script>
    document.getElementById('emojiButton').addEventListener('click', function() {
        var emojiPanel = document.getElementById('emojiPanel');
        if (emojiPanel.style.display === 'none') {
            emojiPanel.style.display = 'block';
        } else {
            emojiPanel.style.display = 'none';
        }
    });

    function insertEmoji(emoji) {
        var textarea = document.getElementById('texteInput');
        var cursorPosition = textarea.selectionStart;
        var textBeforeCursor = textarea.value.substring(0, cursorPosition);
        var textAfterCursor = textarea.value.substring(cursorPosition);
        textarea.value = textBeforeCursor + emoji + textAfterCursor;
        updatePreview();
    }

    function updatePreview() {
        var selectedColor = couleurFondInput.value;
        var enteredText = texteInput.value;
        couleurPreview.style.backgroundColor = selectedColor;
        textePreview.textContent = enteredText;
    }
</script>
<script>
    let profileDropdownList = document.querySelector(".profile-dropdown-list");
    let btn = document.querySelector(".profile-dropdown-btn");

    let classList = profileDropdownList.classList;

    const toggle = () => classList.toggle("active");

    window.addEventListener("click", function (e) {
        if (!btn.contains(e.target)) classList.remove("active");
    });
</script>
<script>
    function deconnexion() {
        var form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url 'Model:Deconnexion' %}';
        var csrf = document.createElement('input');
        csrf.type = 'hidden';
        csrf.name = 'csrfmiddlewaretoken';
        csrf.value = '{{ csrf_token }}';
        form.appendChild(csrf);

        document.body.appendChild(form);
        form.submit();
    }


</script>
</body>
</html>